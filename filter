# Load the Azure data (this is your dump from Azure)
$azureData = Import-Csv -Path "azureData.csv"

# Load the exceptions JSON
$exceptions = Get-Content -Raw -Path "exceptions.json" | ConvertFrom-Json

# Example structure of exceptions JSON
# $exceptions = @{
#     "staticSPNs" = @("spnobjtID1", "spnobjtID2")
#     "nameLikePatterns" = @("*liftav*", "*network-rg*")
#     "expiryDateExceptions" = @("spnobjtID3")
# }

# Function to check if SPN matches name patterns
function MatchesPattern {
    param ($spnName, $patterns)
    foreach ($pattern in $patterns) {
        if ($spnName -like $pattern) {
            return $true
        }
    }
    return $false
}

# Function to check if SPN is part of static SPN list
function IsStaticSPN {
    param ($spnObjtID, $staticSPNs)
    return $staticSPNs -contains $spnObjtID
}

# Filtering logic
$filteredData = $azureData | Where-Object {
    $spnObjtID = $_.spnobjtID
    $spnName = $_.spnname
    $expiryDate = $_.expirydate

    # Check if the SPN is a static SPN, or matches a name pattern
    -not (IsStaticSPN $spnObjtID $exceptions.staticSPNs) -and
    -not (MatchesPattern $spnName $exceptions.nameLikePatterns) -and
    -not ($exceptions.expiryDateExceptions -contains $spnObjtID) -and
    # Optionally, add additional checks here
    $expiryDate -gt [DateTime]::Now # Only keep non-expired SPNs
}

# Export filtered data
$filteredData | Export-Csv -Path "filteredData.csv" -NoTypeInformation
