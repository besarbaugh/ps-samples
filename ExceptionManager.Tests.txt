# Import the module before running tests
$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Definition
Import-Module (Join-Path $scriptDir "..\modules\ExceptionManager.psm1")

# Start the Pester test block
Describe 'ExceptionManager Module Tests' {

    # Test for Get-Exceptions
    Describe 'Get-Exceptions' {
        It 'Should return a hashtable from a valid file path' {
            $exceptions = Get-Exceptions
            $exceptions | Should -Not -BeNullOrEmpty
            $exceptions | Should -BeOfType 'hashtable'
        }

        It 'Should throw an error if the file path does not exist' {
            { Get-Exceptions } | Should -Throw "File not found"
        }
    }

    # Test for Test-ExceptionSchema
    Describe 'Test-ExceptionSchema' {
        It 'Should return $true for a valid exception' {
            $validException = @{
                spnname_patterns = @{
                    patterns = @("*prod*", "*service*")
                    match_type = "OR"
                }
                spndeptid = "Dept001"
                containertype = @("rg")
                role = @("owner")
                environment = "prod"
                dynamic = $true
                dynamic_scope = $false
                exception_type = "dynamic"
            }

            $result = Test-ExceptionSchema -Exception $validException
            $result | Should -Be $true
        }

        It 'Should return $false for an invalid exception' {
            $invalidException = @{
                spnname_patterns = @{
                    patterns = @("*prod*", "*service*")
                    match_type = "OR"
                }
                # Missing required fields like SPNDeptID, containertype, etc.
            }

            $result = Test-ExceptionSchema -Exception $invalidException
            $result | Should -Be $false
        }

        It 'Should fail if TakeAwayID is present but expiration_date is missing' {
            $invalidException = @{
                spnname_patterns = @{
                    patterns = @("*prod*")
                    match_type = "OR"
                }
                spndeptid = "Dept001"
                containertype = @("rg")
                role = @("owner")
                environment = "prod"
                dynamic = $true
                dynamic_scope = $false
                exception_type = "dynamic"
                takeawayid = "TakeAway123"
                # Missing expiration_date
            }

            $result = Test-ExceptionSchema -Exception $invalidException
            $result | Should -Be $false
        }
    }

    # Test for Add-Exception
    Describe 'Add-Exception' {
        It 'Should add a new exception to a valid exceptions.json file' {
            $spnNamePatterns = @{
                patterns = @("*prod*", "*service*")
                match_type = "OR"
            }

            # Add the exception
            Add-Exception -SpnNamePatterns $spnNamePatterns `
                          -SPNDeptID "Dept001" `
                          -ContainerTypes @("rg") `
                          -Roles @("owner") `
                          -Environment "prod" `
                          -Dynamic $true `
                          -DynamicScope $false `
                          -ExceptionType "dynamic" `
                          -ExpirationDate (Get-Date).AddMonths(6)

            # Verify the addition
            $updatedExceptions = Get-Exceptions
            $updatedExceptions.Exceptions.Count | Should -BeGreaterThan 0
        }

        It 'Should throw an error if a duplicate exception is added' {
            $spnNamePatterns = @{
                patterns = @("*prod*", "*service*")
                match_type = "OR"
            }

            # Add the same exception twice, expecting the second to fail
            Add-Exception -SpnNamePatterns $spnNamePatterns `
                          -SPNDeptID "Dept001" `
                          -ContainerTypes @("rg") `
                          -Roles @("owner") `
                          -Environment "prod" `
                          -Dynamic $true `
                          -DynamicScope $false `
                          -ExceptionType "dynamic" `
                          -ExpirationDate (Get-Date).AddMonths(6)

            { Add-Exception -SpnNamePatterns $spnNamePatterns `
                            -SPNDeptID "Dept001" `
                            -ContainerTypes @("rg") `
                            -Roles @("owner") `
                            -Environment "prod" `
                            -Dynamic $true `
                            -DynamicScope $false `
                            -ExceptionType "dynamic" `
                            -ExpirationDate (Get-Date).AddMonths(6) } | Should -Throw "Duplicate exception found"
        }
    }

    # Test for Save-Exceptions
    Describe 'Save-Exceptions' {
        It 'Should save exceptions to a valid file path' {
            $testExceptions = @{
                Exceptions = @(
                    @{
                        spnname_patterns = @{
                            patterns = @("*prod*", "*service*")
                            match_type = "OR"
                        }
                        spndeptid = "Dept001"
                        containertype = @("rg")
                        role = @("owner")
                        environment = "prod"
                        dynamic = $true
                        dynamic_scope = $false
                        exception_type = "dynamic"
                    }
                )
            }

            Save-Exceptions -ExceptionsList $testExceptions

            # Verify the file was saved
            $fileContent = Get-Content -Path (Join-Path $PSScriptRoot "..\exceptions.json") -Raw | ConvertFrom-Json
            $fileContent.Exceptions.Count | Should -Be 1
        }

        It 'Should throw an error if it fails to save' {
            # Test with an invalid file path
            $invalidFilePath = "C:\invalid\path\exceptions.json"
            $exceptions = @{
                Exceptions = @()
            }

            { Save-Exceptions -ExceptionsList $exceptions } | Should -Throw
        }
    }

}
