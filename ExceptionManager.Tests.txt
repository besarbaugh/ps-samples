# Load the helper functions from the same script file
. "$PSScriptRoot\ExceptionManager.ps1"

# Define the path to the exceptions.json file
$FilePath = Join-Path $PSScriptRoot "..\exceptions.json"

# Sample exceptions for testing
$sampleExceptionValid = @{
    spnname_patterns = @{
        patterns   = @("*sample-spn*")
        match_type = "AND"
    }
    spndeptid = "Dept001"
    containertype = @("RG")
    role = @("owner")
    environment = "Prod"
    dynamic = $true
    dynamic_scope = $false
    exception_type = "permanent"
    containerdeptid = "Dept001"
    containerid = "Container123"
}

$sampleExceptionInvalid = @{
    spnname_patterns = @{
        patterns   = @("*invalid-spn*")
        match_type = "OR"
    }
    spndeptid = "Dept002"
    containertype = @("InvalidType")  # Invalid container type to cause a failure
    role = @("owner")
    environment = "Prod"
    dynamic = $true
    dynamic_scope = $false
    exception_type = "permanent"
    containerdeptid = "Dept002"
    containerid = "Container456"
}

# Sample exception for testing TakeawayID and ExpirationDate
$sampleExceptionWithTakeaway = @{
    spnname_patterns = @{
        patterns   = @("*takeaway-spn*")
        match_type = "OR"
    }
    spndeptid = "Dept003"
    containertype = @("RG")
    role = @("owner")
    environment = "Prod"
    dynamic = $false
    dynamic_scope = $false
    exception_type = "temporary"
    takeawayid = "Takeaway123"
    expiration_date = "2024-12-31T23:59:59Z"
    containerdeptid = "Dept003"
    containerid = "Container789"
}

# Sample exception for ISOApproved
$sampleExceptionISOApproved = @{
    spnname_patterns = @{
        patterns   = @("*isoapproved-spn*")
        match_type = "AND"
    }
    spndeptid = "Dept004"
    containertype = @("Sub")
    role = @("contributor")
    environment = "QA"
    dynamic = $false
    dynamic_scope = $false
    exception_type = "permanent"
    isoapprovedid = "ISO123"
    containerdeptid = "Dept004"
    containerid = "Container890"
}

Describe "ExceptionManager Helper Functions" {

    # Test for Get-Exceptions
    It "Should load existing exceptions without error" {
        # Create a mock exceptions file
        $mockExceptions = @{
            Exceptions = @($sampleExceptionValid)
        }

        $mockJsonContent = $mockExceptions | ConvertTo-Json -Depth 10
        $mockJsonContent | Out-File -FilePath $FilePath -Force

        $loadedExceptions = Get-Exceptions -FilePath $FilePath

        $loadedExceptions.Exceptions | Should -Not -BeNullOrEmpty
        $loadedExceptions.Exceptions.Count | Should -Be 1
    }

    # Test for Save-Exceptions
    It "Should save updated exceptions without error" {
        $updatedExceptions = @{
            Exceptions = @($sampleExceptionValid, $sampleExceptionISOApproved)
        }

        { Save-Exceptions -ExceptionsList $updatedExceptions -FilePath $FilePath } | Should -Not -Throw
    }

    # Test for Test-ExceptionSchema with a valid exception
    It "Should pass schema validation for a valid exception" {
        Test-ExceptionSchema -Exception $sampleExceptionValid | Should -BeTrue
    }

    # Test for Test-ExceptionSchema with an invalid exception
    It "Should fail schema validation for an invalid exception" {
        Test-ExceptionSchema -Exception $sampleExceptionInvalid | Should -BeFalse
    }

    # Test for Add-Exception with a valid exception
    It "Should add a valid exception to the exceptions file" {
        # Reset the exceptions.json file
        $resetExceptions = @{
            Exceptions = @()
        }
        Save-Exceptions -ExceptionsList $resetExceptions -FilePath $FilePath

        Add-Exception -SpnNamePatterns $sampleExceptionValid.spnname_patterns `
                      -SPNDeptID $sampleExceptionValid.spndeptid `
                      -ContainerTypes $sampleExceptionValid.containertype `
                      -Roles $sampleExceptionValid.role `
                      -Environment $sampleExceptionValid.environment `
                      -Dynamic $sampleExceptionValid.dynamic `
                      -DynamicScope $sampleExceptionValid.dynamic_scope `
                      -ExceptionType $sampleExceptionValid.exception_type `
                      -ContainerDeptID $sampleExceptionValid.containerdeptid `
                      -ContainerID $sampleExceptionValid.containerid

        $exceptionsAfterAdd = Get-Exceptions -FilePath $FilePath
        $exceptionsAfterAdd.Exceptions.Count | Should -Be 1
    }

    # Test for duplicate exception
    It "Should not add a duplicate exception" {
        # Add the initial exception
        Add-Exception -SpnNamePatterns $sampleExceptionValid.spnname_patterns `
                      -SPNDeptID $sampleExceptionValid.spndeptid `
                      -ContainerTypes $sampleExceptionValid.containertype `
                      -Roles $sampleExceptionValid.role `
                      -Environment $sampleExceptionValid.environment `
                      -Dynamic $sampleExceptionValid.dynamic `
                      -DynamicScope $sampleExceptionValid.dynamic_scope `
                      -ExceptionType $sampleExceptionValid.exception_type `
                      -ContainerDeptID $sampleExceptionValid.containerdeptid `
                      -ContainerID $sampleExceptionValid.containerid

        # Try adding the duplicate exception
        { Add-Exception -SpnNamePatterns $sampleExceptionValid.spnname_patterns `
                         -SPNDeptID $sampleExceptionValid.spndeptid `
                         -ContainerTypes $sampleExceptionValid.containertype `
                         -Roles $sampleExceptionValid.role `
                         -Environment $sampleExceptionValid.environment `
                         -Dynamic $sampleExceptionValid.dynamic `
                         -DynamicScope $sampleExceptionValid.dynamic_scope `
                         -ExceptionType $sampleExceptionValid.exception_type `
                         -ContainerDeptID $sampleExceptionValid.containerdeptid `
                         -ContainerID $sampleExceptionValid.containerid } | Should -Throw
    }

    # Test for adding an exception with TakeawayID and ExpirationDate
    It "Should add an exception with TakeawayID and ExpirationDate without error" {
        Add-Exception -SpnNamePatterns $sampleExceptionWithTakeaway.spnname_patterns `
                      -SPNDeptID $sampleExceptionWithTakeaway.spndeptid `
                      -ContainerTypes $sampleExceptionWithTakeaway.containertype `
                      -Roles $sampleExceptionWithTakeaway.role `
                      -Environment $sampleExceptionWithTakeaway.environment `
                      -Dynamic $sampleExceptionWithTakeaway.dynamic `
                      -DynamicScope $sampleExceptionWithTakeaway.dynamic_scope `
                      -ExceptionType $sampleExceptionWithTakeaway.exception_type `
                      -TakeawayID $sampleExceptionWithTakeaway.takeawayid `
                      -ExpirationDate $sampleExceptionWithTakeaway.expiration_date `
                      -ContainerDeptID $sampleExceptionWithTakeaway.containerdeptid `
                      -ContainerID $sampleExceptionWithTakeaway.containerid

        $exceptionsAfterAdd = Get-Exceptions -FilePath $FilePath
        $exceptionsAfterAdd.Exceptions | Where-Object { $_.takeawayid -eq $sampleExceptionWithTakeaway.takeawayid } | Should -Not -BeNullOrEmpty
    }

    # Test for adding an exception with ISOApprovedID
    It "Should add an exception with ISOApprovedID without error" {
        Add-Exception -SpnNamePatterns $sampleExceptionISOApproved.spnname_patterns `
                      -SPNDeptID $sampleExceptionISOApproved.spndeptid `
                      -ContainerTypes $sampleExceptionISOApproved.containertype `
                      -Roles $sampleExceptionISOApproved.role `
                      -Environment $sampleExceptionISOApproved.environment `
                      -Dynamic $sampleExceptionISOApproved.dynamic `
                      -DynamicScope $sampleExceptionISOApproved.dynamic_scope `
                      -ExceptionType $sampleExceptionISOApproved.exception_type `
                      -ISOApprovedID $sampleExceptionISOApproved.isoapprovedid `
                      -ContainerDeptID $sampleExceptionISOApproved.containerdeptid `
                      -ContainerID $sampleExceptionISOApproved.containerid

        $exceptionsAfterAdd = Get-Exceptions -FilePath $FilePath
        $exceptionsAfterAdd.Exceptions | Wh
