<#
.SYNOPSIS
    Adds a new exception to a JSON file based on the defined schema.

.DESCRIPTION
    This function creates a new exception object, validates key parameters, and then adds it to an existing JSON file. 
    If the JSON file is empty or does not exist, the function initializes it with an empty array.

.PARAMETER SPNObjectID
    The Object ID of the Service Principal (SPN). Either this or SPNNameLike is required.

.PARAMETER SPNNameLike
    A pattern for SPN name matching. Either this or SPNObjectID is required.

.PARAMETER Role
    The role to assign to the SPN within the specified scope.

.PARAMETER AzScopeObjectID
    The Object ID of the Azure Scope (Resource Group, Subscription, or Management Group). Either this or AzScopeNameLike is required.

.PARAMETER AzScopeNameLike
    A pattern for Azure Scope name matching. Either this or AzScopeObjectID is required.

.PARAMETER AzureScopeType
    The type of Azure Scope (RG, Sub, MG). This helps determine if EonID matching is relevant.

.PARAMETER SPNEonID
    The EonID (or department ID) associated with the SPN. Optional if the container type is not Resource Group.

.PARAMETER AzScopeEonID
    The EonID (or department ID) associated with the Azure Scope. Optional if the container type is not Resource Group.

.PARAMETER ActionPlan
    A hashtable that contains fields like ID, DateAdded, and ExpirationDate. Optional if SecArch is provided.

.PARAMETER SecArch
    A hashtable that contains fields like ID and DateAdded. Optional if ActionPlan is provided.

.PARAMETER FilePath
    The path of the JSON file to which the exception will be added. If the file does not exist, it will be created.

.EXAMPLE
    # Example 1: Add an exception with SPN and Azure Scope Object IDs for a Resource Group
    Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" -AzScopeObjectID "54321-edcba-09876" `
        -AzureScopeType "RG" -SPNEonID "Dept-001" -AzScopeEonID "Dept-001" `
        -ActionPlan @{ ID = "T123"; DateAdded = "2024-10-21"; ExpirationDate = "2025-10-21" } `
        -FilePath "C:\path\to\exceptions.json"

    # Example 2: Add an exception using name-like patterns for a Management Group with SecArch
    Add-Exception -SPNNameLike "*admin-spn*" -Role "AppDevContributor" `
        -AzScopeNameLike "*core-mg*" -AzureScopeType "MG" `
        -SecArch @{ ID = "Sec-123"; DateAdded = "2024-10-21" } `
        -FilePath "C:\path\to\exceptions.json"

.NOTES
    This function supports adding flexible exceptions based on Object IDs or name-like patterns. 
    It also accommodates dynamic behaviors based on different types of Azure containers.
#>

function Add-Exception {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $false)]
        [string]$SPNObjectID,

        [Parameter(Mandatory = $false)]
        [string]$SPNNameLike,

        [Parameter(Mandatory = $true)]
        [string]$Role,

        [Parameter(Mandatory = $false)]
        [string]$AzScopeObjectID,

        [Parameter(Mandatory = $false)]
        [string]$AzScopeNameLike,

        [Parameter(Mandatory = $true)]
        [ValidateSet("RG", "Sub", "MG")]
        [string]$AzureScopeType,

        [Parameter(Mandatory = $false)]
        [string]$SPNEonID,

        [Parameter(Mandatory = $false)]
        [string]$AzScopeEonID,

        [Parameter(Mandatory = $false)]
        [hashtable]$ActionPlan,

        [Parameter(Mandatory = $false)]
        [hashtable]$SecArch,

        [Parameter(Mandatory = $true)]
        [string]$FilePath
    )

    # Validate SPN identifiers
    if (-not $SPNObjectID -and -not $SPNNameLike) {
        Write-Error "You must specify either SPNObjectID or SPNNameLike."
        return
    }

    # Validate Azure Scope identifiers
    if (-not $AzScopeObjectID -and -not $AzScopeNameLike) {
        Write-Error "You must specify either AzScopeObjectID or AzScopeNameLike."
        return
    }

    # Validate EonID presence if required for Resource Groups
    if ($AzureScopeType -eq "RG" -and $SPNEonID -and $AzScopeEonID) {
        if ($SPNEonID -ne $AzScopeEonID) {
            Write-Error "SPN EonID and Azure Scope EonID must match for Resource Groups when both are provided."
            return
        }
    }

    # Validate that either ActionPlan or SecArch is provided
    if (-not $ActionPlan -and -not $SecArch) {
        Write-Error "You must specify either ActionPlan or SecArch."
        return
    }

    # Validate ActionPlan if provided
    if ($ActionPlan) {
        if (-not $ActionPlan.ContainsKey("ID") -or -not $ActionPlan.ContainsKey("DateAdded") -or -not $ActionPlan.ContainsKey("ExpirationDate")) {
            Write-Error "ActionPlan must include ID, DateAdded, and ExpirationDate."
            return
        }
    }

    # Validate SecArch if provided
    if ($SecArch) {
        if (-not $SecArch.ContainsKey("ID") -or -not $SecArch.ContainsKey("DateAdded")) {
            Write-Error "SecArch must include ID and DateAdded."
            return
        }
    }

    # Load the existing JSON file (initialize as an empty array if it is empty)
    $currentData = @()
    if (Test-Path $FilePath) {
        $jsonContent = Get-Content -Path $FilePath -Raw
        if (-not [string]::IsNullOrWhiteSpace($jsonContent)) {
            $currentData = $jsonContent | ConvertFrom-Json
        }
    }

    # Create the new exception object
    $newException = @{
        "SPNObjectID" = $SPNObjectID
        "SPNNameLike" = $SPNNameLike
        "Role" = $Role
        "AzScopeObjectID" = $AzScopeObjectID
        "AzScopeNameLike" = $AzScopeNameLike
        "AzureScopeType" = $AzureScopeType
        "SPNEonID" = $SPNEonID
        "AzScopeEonID" = $AzScopeEonID
        "ActionPlan" = $ActionPlan
        "SecArch" = $SecArch
    }

    # Append the new exception object to the current data
    $currentData += $newException

    # Convert back to JSON and save
    $currentData | ConvertTo-Json -Depth 10 | Set-Content -Path $FilePath -Force
    Write-Output "Exception added to JSON file at: $FilePath"
}

<#
EXAMPLE: 

$actionPlan = @{
    ID = "T123"
    DateAdded = "2024-10-21"
    ExpirationDate = "2025-10-21"
}

Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" -AzScopeObjectID "54321-edcba-09876" `
    -AzureScopeType "RG" -SPNEonID "Dept-001" -AzScopeEonID "Dept-001" `
    -ActionPlan $actionPlan -FilePath "C:\path\to\exceptions.json"



#>



#######


# Pester unit test for Add-Exception function
Describe 'Add-Exception' {
    $testFilePath = "C:\path\to\test-exceptions.json"

    BeforeAll {
        # Initialize an empty JSON file before starting the tests
        Initialize-EmptyJson -FilePath $testFilePath
    }

    AfterEach {
        # Reset the file content after each test to ensure clean slate
        @() | ConvertTo-Json | Set-Content -Path $testFilePath -Force
    }

    It 'Should successfully add an exception with valid inputs for RG' {
        $actionPlan = @{
            ID = "T123"
            DateAdded = "2024-10-21"
            ExpirationDate = "2025-10-21"
        }

        Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "RG" `
            -SPNEonID "Dept-001" -AzScopeEonID "Dept-001" `
            -ActionPlan $actionPlan -FilePath $testFilePath

        # Load and validate the added exception
        $result = Get-Content -Path $testFilePath -Raw | ConvertFrom-Json
        $result | Should -HaveCount 1
        $result[0].SPNObjectID | Should -Be "12345-abcde-67890"
        $result[0].Role | Should -Be "Owner"
        $result[0].ActionPlan.ID | Should -Be "T123"
    }

    It 'Should fail if neither ActionPlan nor SecArch is provided' {
        { Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "Sub" `
            -FilePath $testFilePath } | Should -Throw
    }

    It 'Should fail if EonID fields do not match for RG when both are provided' {
        $actionPlan = @{
            ID = "T123"
            DateAdded = "2024-10-21"
            ExpirationDate = "2025-10-21"
        }

        { Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "RG" `
            -SPNEonID "Dept-001" -AzScopeEonID "Dept-002" `
            -ActionPlan $actionPlan -FilePath $testFilePath } | Should -Throw
    }

    It 'Should successfully add an exception using name-like patterns for MG with SecArch' {
        $secArch = @{
            ID = "Sec-123"
            DateAdded = "2024-10-21"
        }

        Add-Exception -SPNNameLike "*admin-spn*" -Role "AppDevContributor" `
            -AzScopeNameLike "*core-mg*" -AzureScopeType "MG" `
            -SecArch $secArch -FilePath $testFilePath

        # Load and validate the added exception
        $result = Get-Content -Path $testFilePath -Raw | ConvertFrom-Json
        $result | Should -HaveCount 1
        $result[0].SPNNameLike | Should -Be "*admin-spn*"
        $result[0].Role | Should -Be "AppDevContributor"
        $result[0].SecArch.ID | Should -Be "Sec-123"
    }

    It 'Should fail if neither SPNObjectID nor SPNNameLike is provided' {
        $actionPlan = @{
            ID = "T123"
            DateAdded = "2024-10-21"
            ExpirationDate = "2025-10-21"
        }

        { Add-Exception -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "RG" `
            -ActionPlan $actionPlan -FilePath $testFilePath } | Should -Throw
    }

    It 'Should fail if neither AzScopeObjectID nor AzScopeNameLike is provided' {
        $actionPlan = @{
            ID = "T123"
            DateAdded = "2024-10-21"
            ExpirationDate = "2025-10-21"
        }

        { Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzureScopeType "RG" -ActionPlan $actionPlan -FilePath $testFilePath } | Should -Throw
    }

    It 'Should fail if mandatory ActionPlan fields are missing' {
        $actionPlan = @{
            ID = "T123"
            DateAdded = "2024-10-21"
        }

        { Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "RG" `
            -ActionPlan $actionPlan -FilePath $testFilePath } | Should -Throw
    }

    It 'Should fail if mandatory SecArch fields are missing' {
        $secArch = @{
            ID = "Sec-123"
        }

        { Add-Exception -SPNObjectID "12345-abcde-67890" -Role "Owner" `
            -AzScopeObjectID "54321-edcba-09876" -AzureScopeType "RG" `
            -SecArch $secArch -FilePath $testFilePath } | Should -Throw
    }
}
